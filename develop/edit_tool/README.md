# MiniCPM-o Demo 可视化编辑工具

## 概述

一个所见即所得的 Demo 页面编辑工具，支持直接在页面上编辑内容、调整结构、管理资源，无需手动操作 JSON 和文件目录。

## 设计理念

### 沉浸式局部编辑

不同于传统的「编辑模式/预览模式」切换，本工具采用 **Notion 风格的局部编辑**：

- 页面始终保持渲染状态
- 点击某个元素，仅该元素进入编辑态
- 其他元素保持正常显示
- 编辑完成后自动恢复渲染态

### 交互行为

**核心原则：最直觉的操作方式**

| 操作 | 手势 | 说明 |
|------|------|------|
| **编辑文本** | 双击 | 双击任意文本进入编辑态，失焦自动保存 |
| **调整顺序** | 拖拽 | 拖拽元素到目标位置，支持跨层级 |
| **添加元素** | 点击 + | 每个容器底部显示 + 按钮 |
| **删除元素** | 点击 × | Hover 时显示 × 按钮 |
| **更换音频** | 点击 🔄 | 音频播放器旁显示更换按钮 |

**视觉反馈：**

```
正常状态        Hover 状态           双击进入编辑态
─────────────  ─────────────────    ─────────────────────────
MiniCPM 助手   MiniCPM 助手    ×    ┌─────────────────────┐
               (虚线边框+删除按钮)   │ MiniCPM 助手    ✓ × │
                                    └─────────────────────┘
```

**拖拽排序：**

```
拖拽中显示占位符
┌──────────┐
│ 睡前故事 │ ←── 正在拖拽
└──────────┘
     │
     ▼
[童话故事] [────────] [诗歌朗读]
            ↑ 放置位置指示器
```

---

## 数据架构

### 数据流

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            SOURCE LAYER                                  │
├─────────────────────────────────────────────────────────────────────────┤
│  develop/collected/          # 采集系统原始数据（只读）                    │
│  └── {zh,en}/<category>/session_xxx/                                     │
│      ├── system_prefix.txt                                               │
│      ├── system_suffix.txt                                               │
│      ├── system_ref_audio.mp3                                            │
│      ├── 000_user_audio0.asr.txt                                         │
│      ├── 000_assistant.txt                                               │
│      ├── 000_assistant_audio0.mp3                                        │
│      └── ...                                                             │
│                                                                          │
│  develop/edit_tool/resources/  # 编辑器管理的资源（可写）                  │
│  └── {zh,en}/<case_id>/                                                  │
│      ├── ref.mp3                                                         │
│      └── 000_assistant.mp3                                               │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            CONFIG LAYER                                  │
├─────────────────────────────────────────────────────────────────────────┤
│  develop/edit_tool/config/                                               │
│  ├── data_zh.json            # 中文完整数据（编辑器直接读写）              │
│  └── data_en.json            # 英文完整数据（编辑器直接读写）              │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │  导出/构建
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            OUTPUT LAYER                                  │
├─────────────────────────────────────────────────────────────────────────┤
│  minicpm-o-4_5/                                                          │
│  ├── data.js                 # 中文数据                                   │
│  ├── data_en.js              # 英文数据                                   │
│  ├── audio/                  # 音频文件                                   │
│  ├── index.html              # 英文页面（默认）                            │
│  └── index_zh.html           # 中文页面                                   │
└─────────────────────────────────────────────────────────────────────────┘
```

### JSON 数据结构 (`data_zh.json` / `data_en.json`)

```json
{
  "meta": {
    "title": "MiniCPM-o 4.5",
    "description": "下一代全模态语音对话模型",
    "version": "1.0.0"
  },
  "abilities": [
    {
      "id": "minicpm_assistant",
      "name": "MiniCPM 助手",
      "description": "高表现力语音合成，专业声优音色，自然韵律",
      "sub_abilities": [
        {
          "id": "story",
          "name": "故事创作",
          "cases": [
            {
              "id": "haitian_story_001",
              "summary": "睡前故事（轻柔语气）",
              "system": {
                "prefix": "模仿音频样本的音色并生成新的内容。",
                "ref_audio": "resources/zh/haitian_story_001/ref.mp3",
                "suffix": "你的任务是..."
              },
              "turns": [
                {
                  "user_text": "用轻柔的语气讲一个睡前故事",
                  "assistant_text": "今天的故事讲的是...",
                  "assistant_audio": "resources/zh/haitian_story_001/000_assistant.mp3"
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}
```

---

## 页面呈现结构

```
┌─────────────────────────────────────────────────────────────────────────┐
│  HEADER                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │  MiniCPM-o 4.5                                                      ││
│  │  中文 / EN                                            [💾 Save]     ││
│  └─────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  SECTION (Ability)                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │  📌 [ability.name]                                                  ││
│  │  [ability.description]                                              ││
│  │                                                                      ││
│  │  ┌─ SUBSECTION (SubAbility) ───────────────────────────────────────┐││
│  │  │  📎 [sub_ability.name]                                          │││
│  │  │                                                                  │││
│  │  │  [Tab: case.summary] [Tab] [Tab] [+]                            │││
│  │  │                                                                  │││
│  │  │  ┌─ CASE CONTENT ──────────────────────────────────────────────┐│││
│  │  │  │                                                              ││││
│  │  │  │  ┌─ SYSTEM BLOCK ─────────────────────────────────────────┐ ││││
│  │  │  │  │  Prefix: [system.prefix]                               │ ││││
│  │  │  │  │  Ref Audio: [▶ 播放器]                                  │ ││││
│  │  │  │  │  Suffix: [system.suffix]                               │ ││││
│  │  │  │  └────────────────────────────────────────────────────────┘ ││││
│  │  │  │                                                              ││││
│  │  │  │  ┌─ TURN ─────────────────────────────────────────────────┐ ││││
│  │  │  │  │  USER  [turn.user_text]                                │ ││││
│  │  │  │  │  AI    [turn.assistant_text]                           │ ││││
│  │  │  │  │        [▶ 播放器]                                       │ ││││
│  │  │  │  └────────────────────────────────────────────────────────┘ ││││
│  │  │  │                                                              ││││
│  │  │  │  [+ 添加 Turn]                                               ││││
│  │  │  └──────────────────────────────────────────────────────────────┘│││
│  │  │                                                                  │││
│  │  │  [+ 添加 Case]                                                   │││
│  │  └──────────────────────────────────────────────────────────────────┘││
│  │                                                                      ││
│  │  [+ 添加 SubAbility]                                                 ││
│  └─────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────┘

[+ 添加 Ability]
```

---

## 操作集合

### 结构操作

| 操作 | 目标 | 说明 |
|------|------|------|
| 添加 | Ability / SubAbility / Case / Turn | 在对应位置插入新元素 |
| 删除 | Ability / SubAbility / Case / Turn | 删除元素及其子元素 |
| 排序 | 所有层级 | 拖拽或上下移动按钮 |

### 内容编辑

| 操作 | 目标 | 说明 |
|------|------|------|
| 编辑文本 | name / description / summary / prefix / suffix / user_text / assistant_text | 点击进入编辑态 |
| 更换音频 | ref_audio / assistant_audio | 上传新文件替换 |

### 数据导入

| 操作 | 说明 |
|------|------|
| 从 Collected 导入 | 选择 session，自动填充 system 和 turns |
| 上传资源包 | 上传包含音频和文本的 zip |

### 导出

| 操作 | 说明 |
|------|------|
| 保存 | 保存 JSON 到 config/，保存音频到 resources/ |
| 构建 | 生成 data.js / data_en.js，复制音频到 minicpm-o-4_5/audio/ |

---

## 技术实现

### 文件结构

```
develop/edit_tool/
├── index.html          # 编辑器入口
├── editor.js           # 编辑器核心逻辑
├── editor.css          # 编辑器样式
├── server.py           # 本地服务（保存、构建）
├── config/
│   ├── data_zh.json    # 中文数据
│   └── data_en.json    # 英文数据
├── resources/          # 编辑器管理的资源
│   ├── zh/
│   └── en/
└── README.md           # 本文档
```

### 本地服务 API

```
GET  /api/data/{lang}           # 获取数据
POST /api/data/{lang}           # 保存数据
POST /api/upload/{lang}/{path}  # 上传音频
GET  /api/collected/list        # 列出可导入的 sessions
GET  /api/collected/{session}   # 获取 session 详情
POST /api/build                 # 触发构建
```

### 实现计划

**Phase 1: 基础框架** ✅
- [x] 页面渲染（暗色调编辑器风格）
- [x] 双击文本进入编辑态
- [x] 数据加载/显示
- [x] 中英文切换编辑

**Phase 2: 结构编辑** ✅
- [x] 添加/删除 Ability
- [x] 添加/删除 SubAbility
- [x] 添加/删除 Case
- [x] 拖拽排序（同层级）

**Phase 3: 资源管理** 🚧
- [ ] 音频上传/更换
- [ ] 本地服务实现
- [ ] 从 Collected 导入

**Phase 4: 导出构建**
- [x] JSON 导出（浏览器下载）
- [ ] 保存到服务器
- [ ] 构建脚本适配
- [ ] 生成最终产物

---

## 使用方式

```bash
# 启动服务器
cd develop/edit_tool
python3 server.py --port 8080

# 访问编辑器
open http://localhost:8080/develop/edit_tool/index.html

# 工作流程
# 1. 编辑：双击文本编辑、拖拽排序、点击按钮添加/删除
# 2. 保存：点击「💾 保存」或 Ctrl+S，保存到 config/data_{lang}.json
# 3. 构建：点击「🔨 构建」或 Ctrl+B，生成 minicpm-o-4_5/data.js
# 4. 预览：点击「👁 预览」查看最终效果
```

## 快捷键

| 快捷键 | 功能 |
|--------|------|
| `双击` | 进入文本编辑模式 |
| `Enter` | 完成编辑 |
| `Escape` | 取消编辑 |
| `Ctrl+S` / `Cmd+S` | 保存到服务器 |
| `Ctrl+B` / `Cmd+B` | 触发构建 |
